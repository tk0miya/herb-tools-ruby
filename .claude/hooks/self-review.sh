#!/bin/bash
#
# PostToolUse hook for self-review after git push
#
# This script triggers a self-review process after git push operations.
# The output is fed back to Claude, prompting it to perform a code review.
#

set -euo pipefail

# Read JSON input from stdin
input=$(cat)

tool_name=$(echo "$input" | jq -r '.tool_name // empty')
command=$(echo "$input" | jq -r '.tool_input.command // empty')

# Only run for Bash tool
if [[ "$tool_name" != "Bash" ]]; then
  exit 0
fi

# Check if it's a git push command
if [[ ! "$command" =~ git[[:space:]]+push ]]; then
  exit 0
fi

# Check if push was successful
exit_code=$(echo "$input" | jq -r '.tool_response.exit_code // 0')

if [[ "$exit_code" != "0" ]]; then
  # Push failed, no need for review
  exit 0
fi

# Output self-review prompt
cat << 'EOF'

==============================================================================
SELF-REVIEW REQUIRED
==============================================================================

A git push has been completed. Please use the Task tool with subagent_type
"Explore" to perform a self-review of the changes. This separates the review
context from the main session.

## Subagent Prompt

Use the following prompt for the subagent:

"First, read CLAUDE.md to understand the project rules and conventions.
Then review the recent git push. Run `git log origin/main..HEAD --stat` and
`git diff origin/main...HEAD` to examine all changes from the branch point.
Check for:
1. Correctness: requirements met, logic errors, edge cases
2. Code Quality: naming, readability, follows project conventions
3. Testing: test coverage for new functionality
4. Security: vulnerabilities, input validation
5. Commit Quality: each commit should be a meaningful unit of work.
   If there are minor fix commits (typos, forgotten changes, careless mistakes),
   suggest squashing them into the relevant commit before merging.

Report findings and suggest fixes if needed."

## After Review

If the subagent reports issues, create follow-up commits to address them.

==============================================================================
EOF

exit 0
